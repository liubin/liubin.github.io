
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- include head -->
    

<meta charset="utf-8">
<title>Nydus 源码解读：nydusify convert - 人间指南</title>
<meta name="author" content="bin liu">
<meta name="description"
      content="Nydus 源码解读：nydusify convert 这是 nydus 源码学习的笔记，主要是介绍 nydusify convert 命令的流程，该命令主要用于转换 nydus 镜像，比如将 Docker Hub 上的镜像转换为 nydus 镜像，并保存到 registry。 &hellip;">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="canonical" href="http://liubin.org/blog/2022/05/10/nydusify-convert">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css">
<link href="/atom.xml"
      rel="alternate"
      title="人间指南"
      type="application/atom+xml">




<script src="/javascripts/modernizr-2.0.js" type="text/javascript"></script>
<script src="/javascripts/ender.js" type="text/javascript"></script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5658682']);
  _gaq.push(['_trackPageview']);  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
      '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3ff1a0a2cfe6655d0058381167b966a9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <!-- /include -->
  </head>
  <body>
    <div id="wrapper">

      <header role="banner" class="site_metas">
	<!-- include header -->
	
<hgroup>
  <h1><a href="/">人间指南</a></h1>
  
  <h2>一个软件工程师的自言自语</h2>
  
</hgroup>

	<!-- /include -->
        <!-- include social_service_links -->
	
<div id="social-links">
  <ul>
    
    <li id="social-links-github">
      <a title="GitHub" href="https://github.com/liubin">github</a>
    </li>
    
    
    <li id="social-links-twitter">
      <a title="twitter" href="http://twitter.com/liubuneng">twitter</a>
    </li>
    
    
    <li id="social-links-feed">
      <a title="feed" href="http://liubin.org/atom.xml">feed</a>
    </li>
  </ul>
</div>


        <!-- /include -->
      </header>

      <div id="content">
	<!-- content -->
	

  


<article class="entry" role="article">

  <header>
    <h2 class="entry_title">Nydus 源码解读：nydusify convert</h2>
    
  </header>

  <div class="entry_content"><p>这是 nydus 源码学习的笔记，主要是介绍 nydusify convert 命令的流程，该命令主要用于转换 nydus 镜像，比如将 Docker Hub 上的镜像转换为 nydus 镜像，并保存到 registry。</p>

<p>本例使用了一个非常简单的例子，所需要的命令为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nydusify  convert <span class="se">\</span>
</span><span class='line'>    --source liubin/nydus:two-layers <span class="se">\</span>
</span><span class='line'>    --target localhost:5000/test-nydus
</span></code></pre></td></tr></table></div></figure>


<p>其中源镜像 <code>liubin/nydus:two-layers</code> 是一个基于 alpine 的镜像，一共有两层。</p>

<h2>启动 registry</h2>

<p>转换后的 target 镜像会保存到自己创建的 registry 里，所以我们先在本地启动一个 registry 容器。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -d -p 5000:5000 --restart<span class="o">=</span>always --name registry registry:2
</span></code></pre></td></tr></table></div></figure>


<h2>镜像转换流程</h2>

<p>nydusify 命令转换镜像大概流程很简单：</p>

<ul>
<li>解析源镜像，得的 manifest/config/layers 信息</li>
<li>下载每个 layer，并使用 nydus-image create 命令基于 OCI 镜像层目录进行转换，上传 bootstrap 和 blob 文件</li>
<li>组装 nydus 的 manifest 或 index 文件，上传到 target registry</li>
</ul>


<p>这里我们就以 <a href="https://github.com/dragonflyoss/image-service/tree/v2.0.0-rc.5">v2.0.0-rc.5</a> 为基础，看看具体的转换是怎么执行的。</p>

<p>nydusify 的代码在 <code>contrib/nydusify</code> 目录下，真正的、主要的执行在 contrib/nydusify/pkg/converter/converter.go 中的 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/contrib/nydusify/pkg/converter/converter.go#L163-L376">convert</a> 函数。这里是它的主要流程，我们删掉了一些不妨碍本文主旨的部分代码，比如 cache 相关的内容，以方面解说。</p>

<p>同时为方便阅读，解说也都以注释的方式放到了代码中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// 解析源镜像，获得一个 layer 数组</span>
</span><span class='line'><span class="c1">// 注意，这里镜像其实已经解析过了，此处只是基于解析的镜像从新组装了</span>
</span><span class='line'><span class="c1">// 一个 []SourceLayer{} 数组。</span>
</span><span class='line'><span class="nx">sourceLayers</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sourceProvider</span><span class="p">.</span><span class="nx">Layers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 两个 worker，一个用于 pull 源镜像，一个用于 push nydus 的 blob 和 bootstrap 。</span>
</span><span class='line'><span class="nx">pullWorker</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">NewQueueWorkerPool</span><span class="p">(</span><span class="nx">PullWorkerCount</span><span class="p">,</span> <span class="nb">uint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">sourceLayers</span><span class="p">)))</span>
</span><span class='line'><span class="nx">pushWorker</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">NewWorkerPool</span><span class="p">(</span><span class="nx">PushWorkerCount</span><span class="p">,</span> <span class="nb">uint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">sourceLayers</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// build nydus 镜像的主要数据结构，对应镜像的一层</span>
</span><span class='line'><span class="nx">buildLayers</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">buildLayer</span><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Pull and mount source layer in pull worker</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">parentBuildLayer</span> <span class="o">*</span><span class="nx">buildLayer</span>
</span><span class='line'><span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">sourceLayer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sourceLayers</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">buildLayer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">buildLayer</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">index</span><span class="p">:</span>          <span class="nx">idx</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">buildWorkflow</span><span class="p">:</span>  <span class="nx">buildWorkflow</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">bootstrapsDir</span><span class="p">:</span>  <span class="nx">bootstrapsDir</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">remote</span><span class="p">:</span>         <span class="nx">cvt</span><span class="p">.</span><span class="nx">TargetRemote</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">source</span><span class="p">:</span>         <span class="nx">sourceLayer</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">parent</span><span class="p">:</span>         <span class="nx">parentBuildLayer</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">referenceBlobs</span><span class="p">:</span> <span class="nx">blobLayers</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// 由于镜像层有父子关系，所以这个关联关系还是需要在构建的时候传递下去的</span>
</span><span class='line'>  <span class="nx">parentBuildLayer</span> <span class="p">=</span> <span class="nx">buildLayer</span>
</span><span class='line'>  <span class="nx">buildLayers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">buildLayers</span><span class="p">,</span> <span class="nx">buildLayer</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">job</span> <span class="o">:=</span> <span class="nx">mountJob</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">ctx</span><span class="p">:</span>   <span class="nx">ctx</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">layer</span><span class="p">:</span> <span class="nx">buildLayer</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 添加到 pull worker 队列</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pullWorker</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">job</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Put layer pull job to worker&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">jobChan</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pullWorker</span><span class="p">.</span><span class="nx">Waiter</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">select</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nx">_job</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">jobChan</span><span class="p">:</span>
</span><span class='line'>      <span class="nx">job</span> <span class="o">:=</span> <span class="nx">_job</span><span class="p">.(</span><span class="o">*</span><span class="nx">mountJob</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 从队列中拿到一个 job ，然后调用 job 的 Build 方法，这也是 build 的主要执行体</span>
</span><span class='line'>      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">job</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Build</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 然后把这个 job 的 Push 方法添加到 push 队列</span>
</span><span class='line'>      <span class="nx">pushWorker</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">job</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>  <span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pushWorker</span><span class="p">.</span><span class="nx">Err</span><span class="p">():</span>
</span><span class='line'>      <span class="c1">// 这里是为了快速拿到 push 错误后结束的特殊处理</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 等待所有层 push 成功完成</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pushWorker</span><span class="p">.</span><span class="nx">Waiter</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Push Nydus layer in wait&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Push OCI manifest, Nydus manifest and manifest index</span>
</span><span class='line'><span class="nx">mm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">manifestManager</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">sourceProvider</span><span class="p">:</span> <span class="nx">sourceProvider</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">remote</span><span class="p">:</span>         <span class="nx">cvt</span><span class="p">.</span><span class="nx">TargetRemote</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">buildLayers</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ... ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数虽然比较长，但是逻辑流程还是很清晰的。</p>

<p>下面我们再深入到细节看看具体不同步骤所完成的工作。</p>

<h3>获取源镜像的 manifest 信息</h3>

<p>这里是在<a href="https://github.com/dragonflyoss/image-service/blob/ae79d5a6ae9a29cf010fbce3b73dd0751f1bd52d/contrib/nydusify/pkg/converter/provider/source.go#L173-L205">初始化 sourceProvider</a> 的时候做的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">DefaultSource</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">remote</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Remote</span><span class="p">,</span> <span class="nx">workDir</span><span class="p">,</span> <span class="nx">platform</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">SourceProvider</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">parser</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">remote</span><span class="p">,</span> <span class="nx">arch</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">parsed</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">sp</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">SourceProvider</span><span class="p">{</span>
</span><span class='line'>      <span class="o">&amp;</span><span class="nx">defaultSourceProvider</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">workDir</span><span class="p">:</span> <span class="nx">workDir</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">image</span><span class="p">:</span>   <span class="o">*</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">OCIImage</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">remote</span><span class="p">:</span>  <span class="nx">remote</span><span class="p">,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">sp</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里我们就不再深入解释 parser 相关代码，有兴趣可以参考<a href="https://github.com/dragonflyoss/image-service/blob/ae79d5a6ae9a29cf010fbce3b73dd0751f1bd52d/contrib/nydusify/pkg/parser/parser.go#L185-L264">这里</a>。</p>

<p>我们的测试镜像 liubin/nydus:two-layers 没有 index，只有 manifest，它的解析过程以及信息如下面小节介绍。</p>

<h4>获取 image</h4>

<p>请求 <a href="https://registry-1.docker.io/v2/liubin/nydus/manifests/two-layers">https://registry-1.docker.io/v2/liubin/nydus/manifests/two-layers</a> ，获得数据为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:00e2afc814fb9c3c48858dc5b17758e49ca2619f2bdd544c6f9810c397d83137&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">735</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>获取 manifest</h4>

<p>请求 <a href="https://registry-1.docker.io/v2/liubin/nydus/manifests/sha256:00e2afc814fb9c3c48858dc5b17758e49ca2619f2bdd544c6f9810c397d83137">https://registry-1.docker.io/v2/liubin/nydus/manifests/sha256:00e2afc814fb9c3c48858dc5b17758e49ca2619f2bdd544c6f9810c397d83137</a> ，得到该镜像的 manifest 信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;schemaVersion&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.container.image.v1+json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:85f3e7735ea66cc3df14a38419b199913b84d616298fb38d1a4a5c92cf885d49&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1674</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:a0d0a0d46f8b52473982a3c466318f479767577551a53ffc9074c9fa7035982e&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2814446</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:f2afd747bba4e4e1ae68a143d8f610cc44ae712e988a50ef47c9dfb2fddbc290&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">123</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件很简单，说明该镜像由 1 个 config 对象和 2 个层 组成。</p>

<h4>获取 config 对象</h4>

<p>请求
<a href="https://registry-1.docker.io/v2/liubin/nydus/blobs/sha256:85f3e7735ea66cc3df14a38419b199913b84d616298fb38d1a4a5c92cf885d49">https://registry-1.docker.io/v2/liubin/nydus/blobs/sha256:85f3e7735ea66cc3df14a38419b199913b84d616298fb38d1a4a5c92cf885d49</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-05T07:39:26.692325137Z&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;architecture&quot;</span><span class="p">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;os&quot;</span><span class="p">:</span> <span class="s2">&quot;linux&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Env&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;Cmd&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;/bin/sh&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;rootfs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;diff_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;sha256:e2eb06d8af8218cfec8210147357a68b7e13f7c485b991c288c2d01dc228bb68&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;sha256:f66394ac63df4047b5f85b83ace284471b145ca9d0c029e204318c5641b3fa43&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-08-27T17:19:45.553092363Z&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;/bin/sh -c #(nop) ADD file:aad4290d27580cc1a094ffaf98c3ca2fc5d699fe695dfb8e6e9fac20f1129450 in / &quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-08-27T17:19:45.758611523Z&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;/bin/sh -c #(nop)  CMD [\&quot;/bin/sh\&quot;]&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;empty_layer&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-05T07:39:26.692325137Z&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;/bin/sh -c #(nop) ADD file:d46e26bb98315616de9963c6399d128eabb29c54472e7633417d95a13ee6a287 in / &quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>“节外生枝”的镜像下载</h3>

<p>一般来说，可能我们会按照解析镜像、下载镜像、转换镜像的步骤来做，但是 nydusify 镜像下载却稍微偏离了主处理流程，是在将 job 添加到 pullWorker 中的时候调用的。</p>

<p>具体来说， pullWorker 是一个 QueueWorkerPool 类型的队列，它所接受的任务必须是<a href="https://github.com/dragonflyoss/image-service/blob/ae79d5a6ae9a29cf010fbce3b73dd0751f1bd52d/contrib/nydusify/pkg/utils/worker.go#L14-L17">这样</a>的数据结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">type</span> <span class="nx">RJob</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Do</span><span class="p">()</span> <span class="kt">error</span>
</span><span class='line'>  <span class="nx">Err</span><span class="p">()</span> <span class="kt">error</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而在任务添加到这个队列的时候，会执行该任务的 <a href="https://github.com/dragonflyoss/image-service/blob/ae79d5a6ae9a29cf010fbce3b73dd0751f1bd52d/contrib/nydusify/pkg/utils/worker.go#L53-L60">Do</a> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">job</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pool</span><span class="p">.</span><span class="nx">jobs</span>
</span><span class='line'><span class="c1">// ... ...</span>
</span><span class='line'><span class="nx">err</span> <span class="o">:=</span> <span class="nx">job</span><span class="p">.</span><span class="nx">Do</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>而我们看到前面的 mountJob ，实际上就是 buildLayer 的一个包装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">type</span> <span class="nx">mountJob</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">err</span>    <span class="kt">error</span>
</span><span class='line'>  <span class="nx">ctx</span>    <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
</span><span class='line'>  <span class="nx">layer</span>  <span class="o">*</span><span class="nx">buildLayer</span>
</span><span class='line'>  <span class="nx">umount</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这个任务添加到队列的时候，会执行 mountJob 的 Do() 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">job</span> <span class="o">*</span><span class="nx">mountJob</span><span class="p">)</span> <span class="nx">Do</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">umount</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span>
</span><span class='line'>  <span class="nx">umount</span><span class="p">,</span> <span class="nx">job</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">job</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">job</span><span class="p">.</span><span class="nx">umount</span> <span class="p">=</span> <span class="nx">umount</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">job</span><span class="p">.</span><span class="nx">err</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，在将任务添加到 pullWorker 队列的时候，实际上会调用 buildLayer 的 Mount() 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">layer</span> <span class="o">*</span><span class="nx">buildLayer</span><span class="p">)</span> <span class="nx">Mount</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">bootstrapName</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">layer</span><span class="p">.</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">Digest</span><span class="p">().</span><span class="nx">String</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">layer</span><span class="p">.</span><span class="nx">bootstrapPath</span> <span class="p">=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">layer</span><span class="p">.</span><span class="nx">bootstrapsDir</span><span class="p">,</span> <span class="nx">bootstrapName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">mounts</span><span class="p">,</span> <span class="nx">umount</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">layer</span><span class="p">.</span><span class="nx">sourceMount</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">parseSourceMount</span><span class="p">(</span><span class="nx">mounts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">umount</span><span class="p">,</span> <span class="nx">mountDone</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>mount 方法还会调用 provider.SourceLayer 的 Mount 方法，我们来看一下这个 Mount 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">sl</span> <span class="o">*</span><span class="nx">defaultSourceLayer</span><span class="p">)</span> <span class="nx">Mount</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">([]</span><span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">digestStr</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">Digest</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">WithRetry</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Pull</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">desc</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">defer</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Decompress layer from source stream</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">UnpackTargz</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">mountDir</span><span class="p">,</span> <span class="nx">reader</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Decompress source layer %s&quot;</span><span class="p">,</span> <span class="nx">digestStr</span><span class="p">))</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">umount</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nx">RemoveAll</span><span class="p">(</span><span class="nx">sl</span><span class="p">.</span><span class="nx">mountDir</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">mounts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nx">Type</span><span class="p">:</span>   <span class="s">&quot;oci-directory&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">Source</span><span class="p">:</span> <span class="nx">sl</span><span class="p">.</span><span class="nx">mountDir</span><span class="p">,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mounts</span><span class="p">,</span> <span class="nx">umount</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，对于本例的 OCI 镜像来说，这里会执行真正的 pull 操作来下载一个 layer，然后解压缩，最后返回这个所谓的 mount 目录。其格式类似 <code>tmp/source/sha256:ce91720a155e2c10eba7a0a7e13a64efb22e3545b25f360e0cca426ee5881d59</code> 。</p>

<h3>转换镜像</h3>

<p>转换镜像的操作是按层进行的，主要处理是在 buildLayer（contrib/nydusify/pkg/converter/layer.go） 和 Workflow （contrib/nydusify/pkg/build/workflow.go） 和 Builder （contrib/nydusify/pkg/build/builder.go）中实现的。</p>

<p>简单来说，是 buildLayer 的 Build 方法会调用 Workflow 的 Build 方法，而 Workflow 的 Build 方法则会调用 Builder 的 Run 方法，Builder 最终调用 nydus-image 创建 nydus blob 和 bootstrap。</p>

<p>这中间虽然是层层调用，但多数为组装各种参数，我们直接看到最里层的 Builder 的 Run 函数。其实 Run 函数也很简单，就是组装调用 nydus-image 的参数，然后调用该命令创建 blob 和 bootstrap 文件。</p>

<p>我们就不看具体代码了，实际执行 nydus-image 的命令类似下面这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="err">$</span> <span class="nx">nydus</span><span class="o">-</span><span class="nx">image</span> <span class="nx">create</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">parent</span><span class="o">-</span><span class="nx">bootstrap</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">bootstraps</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="nx">sha256</span><span class="p">:</span><span class="nx">a0d0a0d46f8b52473982a3c466318f479767577551a53ffc9074c9fa7035982e</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">bootstrap</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">bootstraps</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="nx">sha256</span><span class="p">:</span><span class="nx">f2afd747bba4e4e1ae68a143d8f610cc44ae712e988a50ef47c9dfb2fddbc290</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">log</span><span class="o">-</span><span class="nx">level</span> <span class="nx">warn</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">whiteout</span><span class="o">-</span><span class="nx">spec</span> <span class="nx">oci</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">output</span><span class="o">-</span><span class="nx">json</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">bootstraps</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="nx">sha256</span><span class="p">:</span><span class="nx">f2afd747bba4e4e1ae68a143d8f610cc44ae712e988a50ef47c9dfb2fddbc290</span><span class="o">-</span><span class="nx">output</span><span class="p">.</span><span class="nx">json</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">blob</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">blobs</span><span class="o">/</span><span class="nx">d46cfc7b</span><span class="o">-</span><span class="mi">1</span><span class="nx">a5f</span><span class="o">-</span><span class="mi">4101</span><span class="o">-</span><span class="nx">b4bd</span><span class="o">-</span><span class="mi">1016</span><span class="nx">cf46979f</span> \
</span><span class='line'>  <span class="o">--</span><span class="nx">prefetch</span><span class="o">-</span><span class="nx">policy</span> <span class="nx">fs</span> \
</span><span class='line'>  <span class="nx">tmp</span><span class="o">/</span><span class="nx">source</span><span class="o">/</span><span class="nx">sha256</span><span class="p">:</span><span class="nx">ce91720a155e2c10eba7a0a7e13a64efb22e3545b25f360e0cca426ee5881d59</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们看到，最后一个参数，也就是文件系统的目录，正好是前面 defaultSourceLayer 的 Mount 方法返回的 mount 位置。</p>

<h3>上传 blob/bootstrap/manifest 文件</h3>

<p>通过 nydus-image 为所有镜像层都创建完 blob 和 bootstrap 之后，就可以将这些构建物传到 target 里了，这里是我们在本地运行的一个 registry。</p>

<p>具体来说要上传的内包括：</p>

<ul>
<li>bootstrap</li>
<li>blob</li>
<li>manifest</li>
<li>config</li>
<li>index（如果有的话）</li>
</ul>


<p>实现代码在 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/contrib/nydusify/pkg/converter/manifest.go#L197-L379">contrib/nydusify/pkg/converter/manifest.go</a> 文件中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">mm</span> <span class="o">*</span><span class="nx">manifestManager</span><span class="p">)</span> <span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">buildLayers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">buildLayer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="p">(</span>
</span><span class='line'>      <span class="c1">// 用于保存所有 blob 的 ID 列表，</span>
</span><span class='line'>      <span class="c1">// 最后这个列表会保存到 bootstrap 的 </span>
</span><span class='line'>      <span class="c1">// annotations[&quot;containerd.io/snapshot/nydus-blob-ids&quot;] 里</span>
</span><span class='line'>      <span class="nx">blobListInAnnotation</span> <span class="p">[]</span><span class="kt">string</span>
</span><span class='line'>      <span class="nx">referenceBlobs</span>       <span class="p">[]</span><span class="kt">string</span>
</span><span class='line'>      <span class="nx">layers</span>               <span class="p">[]</span><span class="nx">ocispec</span><span class="p">.</span><span class="nx">Descriptor</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">_layer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">buildLayers</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">record</span> <span class="o">:=</span> <span class="nx">_layer</span><span class="p">.</span><span class="nx">GetCacheRecord</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">blobListInAnnotation</span> <span class="p">=</span> <span class="nx">appendBlobs</span><span class="p">(</span><span class="nx">blobListInAnnotation</span><span class="p">,</span> <span class="nx">layersHex</span><span class="p">(</span><span class="nx">_layer</span><span class="p">.</span><span class="nx">referenceBlobs</span><span class="p">))</span>
</span><span class='line'>      <span class="nx">referenceBlobs</span> <span class="p">=</span> <span class="nx">appendBlobs</span><span class="p">(</span><span class="nx">referenceBlobs</span><span class="p">,</span> <span class="nx">layersHex</span><span class="p">(</span><span class="nx">_layer</span><span class="p">.</span><span class="nx">referenceBlobs</span><span class="p">))</span>
</span><span class='line'>      <span class="c1">// try add reference blob layers to manifest</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nx">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">backend</span><span class="p">.</span><span class="nx">RegistryBackend</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">blobDesc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">_layer</span><span class="p">.</span><span class="nx">referenceBlobs</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">!</span><span class="nx">containsLayer</span><span class="p">(</span><span class="nx">layers</span><span class="p">,</span> <span class="nx">blobDesc</span><span class="p">.</span><span class="nx">Digest</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">layers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">layers</span><span class="p">,</span> <span class="nx">blobDesc</span><span class="p">)</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Only need to write lastest bootstrap layer in nydus manifest</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buildLayers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 将 blob ID 列表序列化后保存到 layer 的 annotation 里</span>
</span><span class='line'>          <span class="nx">blobListBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">blobListInAnnotation</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">record</span><span class="p">.</span><span class="nx">NydusBootstrapDesc</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">LayerAnnotationNydusBlobIDs</span><span class="p">]</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">blobListBytes</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">// bootstrap 层也加入 layers 数组</span>
</span><span class='line'>          <span class="nx">layers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">layers</span><span class="p">,</span> <span class="o">*</span><span class="nx">record</span><span class="p">.</span><span class="nx">NydusBootstrapDesc</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 更新 OCI config 属性</span>
</span><span class='line'>  <span class="nx">ociConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">sourceProvider</span><span class="p">.</span><span class="nx">Config</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">ociConfig</span><span class="p">.</span><span class="nx">RootFS</span><span class="p">.</span><span class="nx">DiffIDs</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">{}</span>
</span><span class='line'>  <span class="nx">ociConfig</span><span class="p">.</span><span class="nx">History</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">ocispec</span><span class="p">.</span><span class="nx">History</span><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">desc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">layers</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">layerDiffID</span> <span class="o">:=</span> <span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">(</span><span class="nx">desc</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">LayerAnnotationUncompressed</span><span class="p">])</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">layerDiffID</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">layerDiffID</span> <span class="p">=</span> <span class="nx">desc</span><span class="p">.</span><span class="nx">Digest</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">ociConfig</span><span class="p">.</span><span class="nx">RootFS</span><span class="p">.</span><span class="nx">DiffIDs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ociConfig</span><span class="p">.</span><span class="nx">RootFS</span><span class="p">.</span><span class="nx">DiffIDs</span><span class="p">,</span> <span class="nx">layerDiffID</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 序列化 config 对象然后 push 到 registry</span>
</span><span class='line'>  <span class="nx">configMediaType</span> <span class="o">:=</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">MediaTypeImageConfig</span>
</span><span class='line'>  <span class="nx">configDesc</span><span class="p">,</span> <span class="nx">configBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">MarshalToDesc</span><span class="p">(</span><span class="nx">ociConfig</span><span class="p">,</span> <span class="nx">configMediaType</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">*</span><span class="nx">configDesc</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">configBytes</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Push Nydus image config&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 构建 manifest 对象资源</span>
</span><span class='line'>  <span class="nx">manifestMediaType</span> <span class="o">:=</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">MediaTypeImageManifest</span>
</span><span class='line'>  <span class="nx">nydusManifest</span> <span class="o">:=</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">MediaType</span> <span class="kt">string</span> <span class="s">`json:&quot;mediaType,omitempty&quot;`</span>
</span><span class='line'>      <span class="nx">ocispec</span><span class="p">.</span><span class="nx">Manifest</span>
</span><span class='line'>  <span class="p">}{</span>
</span><span class='line'>      <span class="nx">MediaType</span><span class="p">:</span> <span class="nx">manifestMediaType</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Manifest</span><span class="p">:</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">Manifest</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">Versioned</span><span class="p">:</span> <span class="nx">specs</span><span class="p">.</span><span class="nx">Versioned</span><span class="p">{</span>
</span><span class='line'>              <span class="nx">SchemaVersion</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="nx">Config</span><span class="p">:</span>      <span class="o">*</span><span class="nx">configDesc</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">Layers</span><span class="p">:</span>      <span class="nx">layers</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">Annotations</span><span class="p">:</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">buildInfo</span><span class="p">.</span><span class="nx">Dump</span><span class="p">(),</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 序列化 manifest 对象资源</span>
</span><span class='line'>  <span class="nx">nydusManifestDesc</span><span class="p">,</span> <span class="nx">manifestBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">MarshalToDesc</span><span class="p">(</span><span class="nx">nydusManifest</span><span class="p">,</span> <span class="nx">manifestMediaType</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Marshal Nydus image manifest&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 设置 Platform 属性</span>
</span><span class='line'>  <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">CloneSourcePlatform</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">ManifestOSFeatureNydus</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">nydusManifestDesc</span><span class="p">.</span><span class="nx">Platform</span> <span class="p">=</span> <span class="nx">p</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">!</span><span class="nx">mm</span><span class="p">.</span><span class="nx">multiPlatform</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 构建 manifest 对象资源</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">*</span><span class="nx">nydusManifestDesc</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">manifestBytes</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Push nydus image manifest&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// mm.multiPlatform == true 的话，则在 push manifest 后，还要构造 index 对象</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">*</span><span class="nx">nydusManifestDesc</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">manifestBytes</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;Push nydus image manifest&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 拿到老的 manifest</span>
</span><span class='line'>  <span class="nx">ociManifestDesc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">sourceProvider</span><span class="p">.</span><span class="nx">Manifest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 添加 plotform 属性</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">ociManifestDesc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">CloneSourcePlatform</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">ociManifestDesc</span><span class="p">.</span><span class="nx">Platform</span> <span class="p">=</span> <span class="nx">p</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 获取已有 manifest 列表</span>
</span><span class='line'>  <span class="nx">existManifests</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">getExistsManifests</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// 根据 nydusManifestDesc 和 ociManifestDesc 来组装 index</span>
</span><span class='line'>  <span class="nx">_index</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">makeManifestIndex</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">existManifests</span><span class="p">,</span> <span class="nx">nydusManifestDesc</span><span class="p">,</span> <span class="nx">ociManifestDesc</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">indexMediaType</span> <span class="o">:=</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">MediaTypeImageIndex</span>
</span><span class='line'>  <span class="nx">index</span> <span class="o">:=</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">MediaType</span> <span class="kt">string</span> <span class="s">`json:&quot;mediaType,omitempty&quot;`</span>
</span><span class='line'>      <span class="nx">ocispec</span><span class="p">.</span><span class="nx">Index</span>
</span><span class='line'>  <span class="p">}{</span>
</span><span class='line'>      <span class="nx">MediaType</span><span class="p">:</span> <span class="nx">indexMediaType</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Index</span><span class="p">:</span>     <span class="o">*</span><span class="nx">_index</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 序列化 index 后 push 到 registry</span>
</span><span class='line'>  <span class="nx">indexDesc</span><span class="p">,</span> <span class="nx">indexBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">MarshalToDesc</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">indexMediaType</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">*</span><span class="nx">indexDesc</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">indexBytes</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这就是最后的 manifest push 流程。</p>

<p>方便理解，这里我们把 nydus 镜像的 manifest 和 config 一起 dump 出来方便对比观看。</p>

<p>manifest：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;schemaVersion&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.config.v1+json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:9aed3854ac516fda6913a6e5de3f9d4dd5838f49b89fb956a94227585fdc8c7b&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">447</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.nydus.blob.v1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:d542d4a146037df4e940d6921f0e16e9e0307ea60090e71281655c16ce048f8a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">3687032</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;containerd.io/snapshot/nydus-blob&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.nydus.blob.v1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:0bb9d4bf5810ee24b997ce82186a6ec43c3b6e89ba0e1c8e9288157bb704cdd1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;containerd.io/snapshot/nydus-blob&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:df520c0bae065336a455543acd7abd1ff6437dff7424dfdab327dd50576d6d59&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">18174</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;containerd.io/snapshot/nydus-blob-ids&quot;</span><span class="p">:</span> <span class="s2">&quot;[\&quot;d542d4a146037df4e940d6921f0e16e9e0307ea60090e71281655c16ce048f8a\&quot;,\&quot;0bb9d4bf5810ee24b997ce82186a6ec43c3b6e89ba0e1c8e9288157bb704cdd1\&quot;]&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;containerd.io/snapshot/nydus-bootstrap&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;nydus.trace.builder-version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0.0-acaf55d8d6e4f6aecbbe2fc63443680623d998b2&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;nydus.trace.nydusify-version&quot;</span><span class="p">:</span> <span class="s2">&quot;acaf55d8d6e4f6aecbbe2fc63443680623d998b2.20220510.0340&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;nydus.trace.source-digest&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:00e2afc814fb9c3c48858dc5b17758e49ca2619f2bdd544c6f9810c397d83137&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;nydus.trace.source-reference&quot;</span><span class="p">:</span> <span class="s2">&quot;liubin/nydus:two-layers&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>config：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-05T07:39:26.692325137Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;architecture&quot;</span><span class="p">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;os&quot;</span><span class="p">:</span> <span class="s2">&quot;linux&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Env&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;Cmd&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;/bin/sh&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;rootfs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;diff_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;sha256:d542d4a146037df4e940d6921f0e16e9e0307ea60090e71281655c16ce048f8a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;sha256:0bb9d4bf5810ee24b997ce82186a6ec43c3b6e89ba0e1c8e9288157bb704cdd1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;sha256:1ad6993081526b32b2ba95d94d23808d91ec5f4bac546eb328d539336d66a34a&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>到这里，只是梳理了 nydusify convert 命令的处理流程，下一步，计划再进入到 nydus-image create 命令，看看它是如何将指定的一个层（文件夹）转换为 blob 和 bootstrap 的。</p>

<h2>结束</h2>

<p>这里只是看了大致的流程，相对 nydus-image 来说，nydusify 代码还是相对简单写。</p>

<p>关于 nydus-image 的源码分析，可以参考 <a href="/2022-05-11-nydus-image-create.markdown">这篇文章</a>。</p>
</div>

  <footer>
    <p class="meta">

      

      
      <time datetime="2022-05-10 17:36:02 +0800" pubdate></time>
      

      
      <span class="categories">
	
      </span>
      

    </p>

    
    <div class="sharing">

      
      <a href="http://twitter.com/share"
	 class="twitter-share-button"
	 data-url="http://liubin.org/blog/2022/05/10/nydusify-convert/"
	 data-via="liubuneng"
	 data-counturl="http://liubin.org/blog/2022/05/10/nydusify-convert/" >Tweet</a>
      

      

      
      <div class="fb-like"
	   data-send="true"
	   data-width="450"
	   data-show-faces="false"></div>
      
    </div>
    

    

  </footer>
  
</div>

	<!-- /content -->
      </div>

      <footer role="contentinfo">
	<!-- include footer -->
	<p>
  Copyright &copy; 2022 - bin liu -
  <span>
    <a title="About" href="/about">About me</a>
  </span>
  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> 
</p>

	<!-- /include -->
      </footer>
      
      <!-- include after_footer -->
      



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




      <!-- /include -->

    </div>
  </body>
</html>
