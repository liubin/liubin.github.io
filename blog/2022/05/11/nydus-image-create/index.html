
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- include head -->
    

<meta charset="utf-8">
<title>Nydus 源码解读：nydus-image create - 人间指南</title>
<meta name="author" content="bin liu">
<meta name="description"
      content="Nydus 源码解读：nydus-image create 上一篇 Nydus 源码解读：nydusify convert 介绍了 nydusify convert 命令的大致流程，我们在那一片已经看到，每一层镜像都是通过 nydus-image 命令来转换的。 这一篇我们就来以 v2.0.0- &hellip;">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="canonical" href="http://liubin.org/blog/2022/05/11/nydus-image-create">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css">
<link href="/atom.xml"
      rel="alternate"
      title="人间指南"
      type="application/atom+xml">




<script src="/javascripts/modernizr-2.0.js" type="text/javascript"></script>
<script src="/javascripts/ender.js" type="text/javascript"></script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5658682']);
  _gaq.push(['_trackPageview']);  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
      '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3ff1a0a2cfe6655d0058381167b966a9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <!-- /include -->
  </head>
  <body>
    <div id="wrapper">

      <header role="banner" class="site_metas">
	<!-- include header -->
	
<hgroup>
  <h1><a href="/">人间指南</a></h1>
  
  <h2>一个软件工程师的自言自语</h2>
  
</hgroup>

	<!-- /include -->
        <!-- include social_service_links -->
	
<div id="social-links">
  <ul>
    
    <li id="social-links-github">
      <a title="GitHub" href="https://github.com/liubin">github</a>
    </li>
    
    
    <li id="social-links-twitter">
      <a title="twitter" href="http://twitter.com/liubuneng">twitter</a>
    </li>
    
    
    <li id="social-links-feed">
      <a title="feed" href="http://liubin.org/atom.xml">feed</a>
    </li>
  </ul>
</div>


        <!-- /include -->
      </header>

      <div id="content">
	<!-- content -->
	

  


<article class="entry" role="article">

  <header>
    <h2 class="entry_title">Nydus 源码解读：nydus-image create</h2>
    
  </header>

  <div class="entry_content"><p>上一篇 <a href="/blog/2022/05/10/nydusify-convert/">Nydus 源码解读：nydusify convert</a> 介绍了 <code>nydusify convert</code> 命令的大致流程，我们在那一片已经看到，每一层镜像都是通过 <code>nydus-image</code> 命令来转换的。</p>

<p>这一篇我们就来以 <code>v2.0.0-rc.5</code> 的代码为基础，分析一下 <code>nydus-iamge create</code> 命令的代码。<code>nydus-image</code> 的代码主要在 <code>src/bin/nydus-image</code> 文件夹下。</p>

<h2>测试环境</h2>

<p>我们准备一个简单的文件夹 <code>fs</code>，然后将该文件夹转换为 nydus 镜像。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p fs/dir1
</span><span class='line'><span class="nv">$ </span>mkdir -p fs/dir2
</span><span class='line'><span class="nv">$ </span>touch fs/foo.txt
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>abcde &gt; fs/dir1/bar.txt
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>mkdir -p fs/dir1/dir1-1
</span><span class='line'><span class="nv">$ </span>touch fs/dir1/dir1-1/foo
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>abc &gt; fs/dir1/dir1-1/hello
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>tree fs/
</span><span class='line'>fs/
</span><span class='line'>├── dir1
</span><span class='line'>│   ├── bar.txt
</span><span class='line'>│   └── dir1-1
</span><span class='line'>│       ├── foo
</span><span class='line'>│       └── hello
</span><span class='line'>├── dir2
</span><span class='line'>└── foo.txt
</span><span class='line'>
</span><span class='line'><span class="m">3</span> directories, <span class="m">4</span> files
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意</strong>：这里我们都是使用了常规的文件，没有软硬链接、设备文件等特殊类型的文件。</p>

<p>然后我们使用如下命令来创建 nydus 镜像：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir output
</span><span class='line'><span class="nv">$ </span>nydus-image create <span class="se">\</span>
</span><span class='line'>    --fs-version <span class="m">5</span> <span class="se">\</span>
</span><span class='line'>    --bootstrap output/bootstrap <span class="se">\</span>
</span><span class='line'>    --blob-dir output <span class="se">\</span>
</span><span class='line'>    fs
</span></code></pre></td></tr></table></div></figure>


<p>上面参数的意思分别为：</p>

<ul>
<li><code>--fs-version 5</code>：使用 Rafs 版本 5，目前支持 5/6，但是 6 应该还没有完全开发完成。</li>
<li><code>--bootstrap output/bootstrap</code>：bootstrap 文件的保存位置。</li>
<li><code>--blob-dir output</code>：blob 的保存位置</li>
<li><code>fs</code>：输入文件夹</li>
</ul>


<p>实际上 nydus 支持从 3 种类型的输入源来创建 nydus 镜像：</p>

<ul>
<li>directory</li>
<li>diff</li>
<li>stargz_index</li>
</ul>


<p>其中 stargz 也是一种镜像延迟加载技术。在本例中，我们使用了默认的 directory 方式。这个值可以通过命令行参数 <code>source-type</code> 来控制。</p>

<h2>代码解析</h2>

<p>下面我们就来看一下 nydus-image 的源代码。</p>

<h3>主函数</h3>

<p>nydus-image create 命令的入口在 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/main.rs#L571-L702"><code>src/bin/nydus-image/main.rs</code></a> 里，这里我们不贴代码了，只简单说一下里面干了什么。</p>

<p>这个函数主要创建了几个数据结构：</p>

<ul>
<li>build_ctx（类型：BuildContext）：主要在各函数调用中传递一些变量</li>
<li>blob_mgr（类型：BlobManager）：管理 blob</li>
<li>bootstrap_mgr（类型： BootstrapManager）：管理 bootstrap</li>
<li>builder（类型：Box<dyn Builder>）：执行 build 过程</li>
</ul>


<p>我们看到 builder 是一个接口，它会根据输入源类型的不同而初始化为不同的具体实现。在这个例子中，我们基于文件夹构建 Nydus 镜像，所以这里 builder 的实际类型行为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="n">Box</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">DirectoryBuilder</span><span class="o">::</span><span class="n">new</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，该函数会调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">build_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">blob_mgr</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>来实现 build。</p>

<h3>builder.build() 函数</h3>

<p><a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/builder/directory.rs#L117-L196">builder.build() 函数</a> 内容如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">build</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bootstrap_mgr</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BootstrapManager</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_mgr</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BlobManager</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">BuildOutput</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 创建一个 BootstrapContext，在构建中将 bootstrap 数据保存在内存中</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">bootstrap_ctx</span> <span class="o">=</span> <span class="n">bootstrap_mgr</span><span class="p">.</span><span class="n">create_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">inline_bootstrap</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 基于输入源文件夹在内存中构建文件树结构</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">build_tree_from_fs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="n">layer_idx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="o">::</span><span class="n">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 如果是多层构建，当层数据需要依赖父层进行计算</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">layered</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Merge with lower layer if there&#39;s one, do not prepare `prefetch` list during merging.</span>
</span><span class='line'>        <span class="n">bootstrap</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">tree</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// 本例中不会走入这个分支，这里我们就不介绍 apply 方法了。</span>
</span><span class='line'>        <span class="n">tree</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="n">bootstrap_mgr</span><span class="p">,</span> <span class="n">blob_mgr</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 将树状结构转换为一个平铺的数组</span>
</span><span class='line'>    <span class="c1">// 保存到 `bootstrap_ctx.nodes` 中</span>
</span><span class='line'>    <span class="n">timing_tracer</span><span class="o">!</span><span class="p">(</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">bootstrap</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">tree</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;build_bootstrap&quot;</span>
</span><span class='line'>    <span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump blob file</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">blob_ctx</span> <span class="o">=</span> <span class="n">BlobContext</span><span class="o">::</span><span class="n">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_index</span> <span class="o">=</span> <span class="n">blob_mgr</span><span class="p">.</span><span class="n">alloc_index</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">Blob</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// blob.dump 将内存的数据写入磁盘 blob 文件</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_exists</span> <span class="o">=</span> <span class="n">timing_tracer</span><span class="o">!</span><span class="p">(</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">blob</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span>
</span><span class='line'>                <span class="n">ctx</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">blob_ctx</span><span class="p">,</span>
</span><span class='line'>                <span class="n">blob_index</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">blob_mgr</span><span class="p">.</span><span class="n">chunk_dict_cache</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;dump_blob&quot;</span>
</span><span class='line'>    <span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">blob_writer</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_id</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">blob_id</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 这里的 blob_exists 表示 compressed_blob_size  &gt; 0，即 blob 文件大小大于 0 </span>
</span><span class='line'>    <span class="k">if</span> <span class="n">blob_exists</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">blob_writer</span><span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">blob_id</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// Add new blob to blob table.</span>
</span><span class='line'>        <span class="n">blob_mgr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">blob_ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 将 bootstrap 写入文件</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_table</span> <span class="o">=</span> <span class="n">blob_mgr</span><span class="p">.</span><span class="n">to_blob_table</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bootstrap</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blob_table</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bootstrap_mgr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>build_tree_from_fs</code> 函数也比较简单，就是构建文件夹结构，最后保存到 Tree 里：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span><span class="p">(</span><span class="n">crate</span><span class="p">)</span> <span class="k">struct</span> <span class="n">Tree</span> <span class="p">{</span>
</span><span class='line'>    <span class="c-Doc">/// Filesystem node.</span>
</span><span class='line'>    <span class="k">pub</span> <span class="n">node</span><span class="o">:</span> <span class="n">Node</span><span class="p">,</span>
</span><span class='line'>    <span class="c-Doc">/// Children tree nodes.</span>
</span><span class='line'>    <span class="k">pub</span> <span class="n">children</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Tree</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中一个 node 表示一个文件/文件夹，而 children 则表示该文件夹下的子文件夹或者文件。</p>

<p>有了文件夹的树状结构，bootstrap 就可以开始 build 了。</p>

<h3>Bootstrap build() 和 build_rafs 函数</h3>

<p><a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/core/bootstrap.rs#L57-L86">build()</a> 函数时构建 bootstrap 的入口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">build</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bootstrap_ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BootstrapContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">tree</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Tree</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 设置为 root 节点</span>
</span><span class='line'>    <span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">RAFS_ROOT_INODE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_ino</span><span class="p">(</span><span class="n">RAFS_ROOT_INODE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">inode_map</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
</span><span class='line'>        <span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">src_ino</span><span class="p">,</span> <span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">src_dev</span><span class="p">),</span>
</span><span class='line'>        <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">],</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// 将根节点 push 进去</span>
</span><span class='line'>    <span class="n">nodes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 调用 build_rafs 构建子节点</span>
</span><span class='line'>    <span class="bp">self</span><span class="p">.</span><span class="n">build_rafs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">nodes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 将结果保存到 bootstrap_ctx.nodes 中</span>
</span><span class='line'>    <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/core/bootstrap.rs#L126-L252"><code>build_rafs</code></a> 函数会遍历前面生成的节点列表，为各节点设置 inode 属性，包括 index，ino，子节点数量等。</p>

<p>这个函数会递归的进行构建，所以有一个参数 tree 表示当前节点，对于子节点，如果是文件夹的话，还会继续调用 build_rafs 函数，构建子节点的数据结构。</p>

<p><code>nodes</code> 参数是一个全局的 Node 列表，这是一个将树状结构转换为一维数组的结构。</p>

<p>函数内容如下。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">build_rafs</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bootstrap_ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BootstrapContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">tree</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Tree</span><span class="p">,</span>
</span><span class='line'>    <span class="n">nodes</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 分配 index，新的值为 nodes 数组长度 + 1</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">index</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 每个 node 都会有这个 index 属性，方便从 nodes 数组获取该节点</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">nodes</span><span class="p">[</span><span class="n">tree</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">index</span> <span class="k">as</span> <span class="n">usize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Maybe the parent is not a directory in multi-layers build scenario, so we check here.</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">parent</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_child_index</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span><span class='line'>        <span class="n">parent</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_child_count</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">dirs</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;&amp;</span><span class="k">mut</span> <span class="n">Tree</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">parent_ino</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">ino</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">child</span> <span class="k">in</span> <span class="n">tree</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">index</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span><span class='line'>        <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_parent</span><span class="p">(</span><span class="n">parent_ino</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 这里删除了 hardlink 处理的代码</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!</span><span class="n">hardlink</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 分配 ino，也就是数组索引</span>
</span><span class='line'>            <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_ino</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span><span class='line'>            <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">set_nlink</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 这里处理 whiteout 类型</span>
</span><span class='line'>        <span class="k">match</span> <span class="p">(</span>
</span><span class='line'>            <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">layered</span><span class="p">,</span>
</span><span class='line'>            <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">whiteout_type</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">whiteout_spec</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="nb">Some</span><span class="p">(</span><span class="n">whiteout_type</span><span class="p">))</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// 这里省略 layered 的处理</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nb">Some</span><span class="p">(</span><span class="n">whiteout_type</span><span class="p">))</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Remove overlayfs opaque xattr for single layer build</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">whiteout_type</span> <span class="o">==</span> <span class="n">WhiteoutType</span><span class="o">::</span><span class="n">OverlayFsOpaque</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">child</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">node</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">remove_xattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OsString</span><span class="o">::</span><span class="n">from</span><span class="p">(</span><span class="n">OVERLAYFS_WHITEOUT_OPAQUE</span><span class="p">));</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">nodes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// 这个例子中走默认分支，</span>
</span><span class='line'>                <span class="c1">// 将 child.node 添加到 nodes 数组</span>
</span><span class='line'>                <span class="n">nodes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 如果当前 child 是文件夹，还需要再次递归处理</span>
</span><span class='line'>        <span class="c1">// 所以将该文件夹保存到 dirs 数组</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">dirs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 循环完当前节点的 children 之后</span>
</span><span class='line'>    <span class="c1">// 还需要再次递归处理子文件夹</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">dir</span> <span class="k">in</span> <span class="n">dirs</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">build_rafs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>经过上面的两个函数的处理，就将所有节点的数据保存到了 bootstrap_ctx.nodes 中，接着就可以生成 bootstrap 和 blob 文件了。</p>

<h3>blob.dump</h3>

<p>blob 的 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/core/blob.rs#L26-L82">dump()</a> 方法位于 <code>src/bin/nydus-image/core/blob.rs</code> 文件中。</p>

<p>其内容如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">dump</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">:</span> <span class="n">ChunkDict</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="n">BlobContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_index</span><span class="o">:</span> <span class="kt">u32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">nodes</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">chunk_dict</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">ctx</span><span class="p">.</span><span class="n">source_type</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SourceType</span><span class="o">::</span><span class="n">Directory</span> <span class="o">|</span> <span class="n">SourceType</span><span class="o">::</span><span class="n">Diff</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// layout_blob_simple 函数用于从 Vec&lt;Node&gt; 类型的 nodes</span>
</span><span class='line'>            <span class="c1">// 返回 Vec&lt;usize&gt; 类型的 inodes</span>
</span><span class='line'>            <span class="c1">// prefetch 相关的变量和预拉取有关，这里我们暂时忽略</span>
</span><span class='line'>            <span class="kd">let</span> <span class="p">(</span><span class="n">inodes</span><span class="p">,</span> <span class="n">prefetch_entries</span><span class="p">)</span> <span class="o">=</span> <span class="n">blob_ctx</span>
</span><span class='line'>                <span class="p">.</span><span class="n">blob_layout</span>
</span><span class='line'>                <span class="p">.</span><span class="n">layout_blob_simple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">prefetch</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// inodes 类型为 Vec&lt;usize&gt; ，inode 即 usize，</span>
</span><span class='line'>            <span class="c1">// 用这个 inode 作为数组索引，从 nodes 数组获取 node 元素</span>
</span><span class='line'>            <span class="c1">// 然后再调用 node 的 dump_blob 将 node 的信息写到磁盘</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">inode</span><span class="p">)</span> <span class="k">in</span> <span class="n">inodes</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">nodes</span><span class="p">[</span><span class="o">*</span><span class="n">inode</span><span class="p">];</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">node</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">dump_blob</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">blob_ctx</span><span class="p">,</span> <span class="n">blob_index</span><span class="p">,</span> <span class="n">chunk_dict</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to dump blob chunks&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">SourceType</span><span class="o">::</span><span class="n">StargzIndex</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 省略 stargz 处理的 case</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 如果没有指定 blob_id，则自动从 blob_hash 创建 ID</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">blob_id</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">blob_id</span> <span class="o">=</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">blob_hash</span><span class="p">.</span><span class="n">clone</span><span class="p">().</span><span class="n">finalize</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// compressed_blob_size &gt; 0 才需要写到磁盘，</span>
</span><span class='line'>    <span class="c1">// 这里返回的 blob_exists 即是该标志</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_exists</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">compressed_blob_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Ok</span><span class="p">(</span><span class="n">blob_exists</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>node.dump_blob</h3>

<p>接着我们来看一下真正的写 blob 的函数，该函数位于 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/core/node.rs#L316-L470">src/bin/nydus-image/core/node.rs</a> 文件中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">dump_blob</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span> <span class="n">ChunkDict</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Node</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BlobContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_index</span><span class="o">:</span> <span class="kt">u32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">chunk_dict</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 针对 symlink 的特殊处理</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_special</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 针对 special 文件的特殊处理</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;failed to open node file {:?}&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">inode_hasher</span> <span class="o">=</span> <span class="n">RafsDigest</span><span class="o">::</span><span class="n">hasher</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">digester</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">blob_size</span> <span class="o">=</span> <span class="mi">0</span><span class="k">u64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// `child_count` of regular file is reused as `chunk_count`.</span>
</span><span class='line'>    <span class="c1">// 一个文件过大的话，大于 chunk size，就要被拆分为多个 chunk 存储。</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.</span><span class="bp">self</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">child_count</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">chunk_size</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="n">i</span> <span class="k">as</span> <span class="kt">u64</span> <span class="o">*</span> <span class="n">chunk_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">child_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 最后一个 chunk，可能实际的 chunk size 小于 blob_ctx.chunk_size</span>
</span><span class='line'>          <span class="c1">// 这里检查下是否 chunk size 不足</span>
</span><span class='line'>            <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">checked_sub</span><span class="p">((</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">anyhow</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;the rest chunk size of inode is bigger than chunk_size&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="p">})</span><span class="o">?</span> <span class="k">as</span> <span class="kt">u32</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">chunk_size</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 使用 read_exact 读取一个 chunk 的数据到 chunk_data</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">chunk_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">chunk_data_buf</span><span class="p">[</span><span class="mf">0.</span><span class="p">.</span><span class="n">chunk_size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">];</span>
</span><span class='line'>        <span class="n">file</span><span class="p">.</span><span class="n">read_exact</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">chunk_data</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;failed to read node file {:?}&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 生成 chunk_id</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">chunk_id</span> <span class="o">=</span> <span class="n">RafsDigest</span><span class="o">::</span><span class="n">from_buf</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">digester</span><span class="p">);</span>
</span><span class='line'>        <span class="n">inode_hasher</span><span class="p">.</span><span class="n">digest_update</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">.</span><span class="n">as_ref</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 生成 chunk 对象，对本例来说这是一个 RafsV5ChunkInfo 类型的数据结构</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">create_chunk</span><span class="p">();</span>
</span><span class='line'>        <span class="n">chunk</span><span class="p">.</span><span class="n">set_id</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 通过对比 chunk digest 来判断是否该 chunk 已经存在</span>
</span><span class='line'>        <span class="c1">// 注意这里从两个缓存的地方获取，</span>
</span><span class='line'>        <span class="c1">// 一个是 blob_ctx.chunk_dict，</span>
</span><span class='line'>        <span class="c1">// 一个是输入参数的 chunk_dict</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">exist_chunk</span> <span class="o">=</span> <span class="k">match</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">chunk_dict</span><span class="p">.</span><span class="n">get_chunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk_id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Some</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="k">true</span><span class="p">)),</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="n">chunk_dict</span><span class="p">.</span><span class="n">get_chunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk_id</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">false</span><span class="p">)),</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">((</span><span class="n">cached_chunk</span><span class="p">,</span> <span class="n">from_dict</span><span class="p">))</span> <span class="o">=</span> <span class="n">exist_chunk</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">cached_chunk</span><span class="p">.</span><span class="n">uncompressed_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>                <span class="o">||</span> <span class="n">cached_chunk</span><span class="p">.</span><span class="n">uncompressed_size</span><span class="p">()</span> <span class="o">==</span> <span class="n">chunk_size</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>              <span class="c1">// 从 cached_chunk 拷贝数据</span>
</span><span class='line'>                <span class="n">chunk</span><span class="p">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">cached_chunk</span><span class="p">);</span>
</span><span class='line'>                <span class="n">chunk</span><span class="p">.</span><span class="n">set_file_offset</span><span class="p">(</span><span class="n">file_offset</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">from_dict</span> <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// 如果是 blob_ctx.chunk_dict 里已存在该 chunk，</span>
</span><span class='line'>                  <span class="c1">// 则设置 blob index 为该 chunk 的 blob id</span>
</span><span class='line'>                    <span class="kd">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">chunk_dict</span><span class="p">.</span><span class="n">get_real_blob_idx</span><span class="p">(</span><span class="n">chunk</span><span class="p">.</span><span class="n">blob_index</span><span class="p">());</span>
</span><span class='line'>                    <span class="n">chunk</span><span class="p">.</span><span class="n">set_blob_index</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="kd">let</span> <span class="n">source</span> <span class="o">=</span> <span class="k">if</span> <span class="n">from_dict</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">ChunkSource</span><span class="o">::</span><span class="n">Dict</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">ChunkSource</span><span class="o">::</span><span class="n">Build</span>
</span><span class='line'>                <span class="p">};</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">NodeChunk</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">source</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">inner</span><span class="o">:</span> <span class="n">chunk</span><span class="p">,</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 没有从任何缓存中获得该 chunk，则创建该 chunk</span>
</span><span class='line'>        <span class="c1">// 首先先对数据进行压缩处理</span>
</span><span class='line'>        <span class="kd">let</span> <span class="p">(</span><span class="n">compressed</span><span class="p">,</span> <span class="n">is_compressed</span><span class="p">)</span> <span class="o">=</span> <span class="n">compress</span><span class="o">::</span><span class="n">compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk_data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">compressor</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;failed to compress node file {:?}&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">compressed_size</span> <span class="o">=</span> <span class="n">compressed</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 4k 对齐</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">aligned_chunk_size</span> <span class="o">=</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">aligned_chunk</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">try_round_up_4k</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">chunk_size</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 更新 blob_ctx 中的一些信息</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">pre_decompress_offset</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">decompress_offset</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">pre_compress_offset</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">compress_offset</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">compress_offset</span> <span class="o">+=</span> <span class="n">compressed_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">decompressed_blob_size</span> <span class="o">=</span>
</span><span class='line'>            <span class="n">blob_ctx</span><span class="p">.</span><span class="n">decompress_offset</span> <span class="o">+</span> <span class="n">aligned_chunk_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">compressed_blob_size</span> <span class="o">+=</span> <span class="n">compressed_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">decompress_offset</span> <span class="o">+=</span> <span class="n">aligned_chunk_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">blob_hash</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compressed</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 将压缩后的 chunk 数据写入到 blob 文件</span>
</span><span class='line'>        <span class="k">if</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">writer</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">writer</span>
</span><span class='line'>                <span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compressed</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to write blob&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 更新 chunk 对象的一些属性</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">chunk_index</span> <span class="o">=</span> <span class="n">blob_ctx</span><span class="p">.</span><span class="n">alloc_index</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="n">chunk</span><span class="p">.</span><span class="n">set_chunk_info</span><span class="p">(</span>
</span><span class='line'>            <span class="n">blob_index</span><span class="p">,</span>
</span><span class='line'>            <span class="n">chunk_index</span><span class="p">,</span>
</span><span class='line'>            <span class="n">file_offset</span><span class="p">,</span>
</span><span class='line'>            <span class="n">pre_decompress_offset</span><span class="p">,</span>
</span><span class='line'>            <span class="n">pre_compress_offset</span><span class="p">,</span>
</span><span class='line'>            <span class="n">compressed_size</span><span class="p">,</span>
</span><span class='line'>            <span class="n">chunk_size</span><span class="p">,</span>
</span><span class='line'>            <span class="n">is_compressed</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">blob_ctx</span><span class="p">.</span><span class="n">add_chunk_meta_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 将 chunk 对象加入到 chunk_dict，即该方法的输入参数</span>
</span><span class='line'>        <span class="n">chunk_dict</span><span class="p">.</span><span class="n">add_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 将 chunk 对象添加到 self.chunks</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">NodeChunk</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">source</span><span class="o">:</span> <span class="n">ChunkSource</span><span class="o">::</span><span class="n">Build</span><span class="p">,</span>
</span><span class='line'>            <span class="n">inner</span><span class="o">:</span> <span class="n">chunk</span><span class="p">,</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="n">blob_size</span> <span class="o">+=</span> <span class="n">compressed_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Ok</span><span class="p">(</span><span class="n">blob_size</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上就是 dump blob 的大致流程。</p>

<h3>bootstrap.dump</h3>

<p>Bootstrap 的 dump 会根据 rafs 版本来调用不同的实现函数，这里我们用的是 v5 的版本，所以实现函数在 <a href="https://github.com/dragonflyoss/image-service/blob/v2.0.0-rc.5/src/bin/nydus-image/core/bootstrap.rs#L373-L502">dump_rafsv5</a> 中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">dump_rafsv5</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BuildContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bootstrap_ctx</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">BootstrapContext</span><span class="p">,</span>
</span><span class='line'>    <span class="n">blob_table</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">RafsV5BlobTable</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 计算文件夹 inode 的 digest</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">idx</span> <span class="k">in</span> <span class="p">(</span><span class="mf">0.</span><span class="p">.</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">len</span><span class="p">()).</span><span class="n">rev</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">digest_node</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">bootstrap_ctx</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Set inode table</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="n">size_of</span><span class="o">::&lt;</span><span class="n">RafsV5SuperBlock</span><span class="o">&gt;</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">inode_table_entries</span> <span class="o">=</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 创建 inode table</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">inode_table</span> <span class="o">=</span> <span class="n">RafsV5InodeTable</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">inode_table_entries</span> <span class="k">as</span> <span class="n">usize</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">inode_table_size</span> <span class="o">=</span> <span class="n">inode_table</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Set blob table, use sha256 string (length 64) as blob id if not specified</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">prefetch_table_offset</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">+</span> <span class="n">inode_table_size</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_table_offset</span> <span class="o">=</span> <span class="n">prefetch_table_offset</span> <span class="o">+</span> <span class="n">prefetch_table_size</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">blob_table_size</span> <span class="o">=</span> <span class="n">blob_table</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">extended_blob_table_offset</span> <span class="o">=</span> <span class="n">blob_table_offset</span> <span class="o">+</span> <span class="n">blob_table_size</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">extended_blob_table_size</span> <span class="o">=</span> <span class="n">blob_table</span><span class="p">.</span><span class="n">extended</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">extended_blob_table_entries</span> <span class="o">=</span> <span class="n">blob_table</span><span class="p">.</span><span class="n">extended</span><span class="p">.</span><span class="n">entries</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 创建 super block</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">super_block</span> <span class="o">=</span> <span class="n">RafsV5SuperBlock</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">inodes_count</span> <span class="o">=</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">inode_map</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_inodes_count</span><span class="p">(</span><span class="n">inodes_count</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_inode_table_offset</span><span class="p">(</span><span class="n">super_block_size</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_inode_table_entries</span><span class="p">(</span><span class="n">inode_table_entries</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_blob_table_offset</span><span class="p">(</span><span class="n">blob_table_offset</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_blob_table_size</span><span class="p">(</span><span class="n">blob_table_size</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_extended_blob_table_offset</span><span class="p">(</span><span class="n">extended_blob_table_offset</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_extended_blob_table_entries</span><span class="p">(</span><span class="kt">u32</span><span class="o">::</span><span class="n">try_from</span><span class="p">(</span><span class="n">extended_blob_table_entries</span><span class="p">)</span><span class="o">?</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_prefetch_table_offset</span><span class="p">(</span><span class="n">prefetch_table_offset</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_prefetch_table_entries</span><span class="p">(</span><span class="n">prefetch_table_entries</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_compressor</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">compressor</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_digester</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">digester</span><span class="p">);</span>
</span><span class='line'>    <span class="n">super_block</span><span class="p">.</span><span class="n">set_chunk_size</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">chunk_size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Set inodes and chunks</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">inode_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">super_block_size</span>
</span><span class='line'>        <span class="o">+</span> <span class="n">inode_table_size</span>
</span><span class='line'>        <span class="o">+</span> <span class="n">prefetch_table_size</span>
</span><span class='line'>        <span class="o">+</span> <span class="n">blob_table_size</span>
</span><span class='line'>        <span class="o">+</span> <span class="n">extended_blob_table_size</span><span class="p">)</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">node</span> <span class="k">in</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">inode_table</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inode_offset</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// Add inode size</span>
</span><span class='line'>        <span class="n">inode_offset</span> <span class="o">+=</span> <span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">inode_size</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// Add chunks size</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">is_reg</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">inode_offset</span> <span class="o">+=</span> <span class="n">node</span><span class="p">.</span><span class="n">inode</span><span class="p">.</span><span class="n">child_count</span><span class="p">()</span> <span class="o">*</span> <span class="n">size_of</span><span class="o">::&lt;</span><span class="n">RafsV5ChunkInfo</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump super block</span>
</span><span class='line'>    <span class="n">super_block</span>
</span><span class='line'>        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to store superblock&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump inode table</span>
</span><span class='line'>    <span class="n">inode_table</span>
</span><span class='line'>        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to store inode table&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump blob table</span>
</span><span class='line'>    <span class="n">blob_table</span>
</span><span class='line'>        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to store blob table&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump extended blob table</span>
</span><span class='line'>    <span class="n">blob_table</span>
</span><span class='line'>        <span class="p">.</span><span class="n">store_extended</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to store extended blob table&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dump inodes and chunks</span>
</span><span class='line'>    <span class="n">timing_tracer</span><span class="o">!</span><span class="p">(</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">node</span> <span class="k">in</span> <span class="o">&amp;</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">nodes</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">node</span><span class="p">.</span><span class="n">dump_bootstrap_v5</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">&quot;failed to dump bootstrap&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;dump_bootstrap&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bootstrap_ctx</span>
</span><span class='line'>        <span class="p">.</span><span class="n">writer</span>
</span><span class='line'>        <span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">bootstrap_ctx</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于 bootstrap 数据中存储的内容，可以参考前几天的 <a href="/blog/2022/04/27/nydus-bootstrap-layout/">这篇文章</a>。</p>

<h2>结束</h2>

<p>Nydus 的代码量还是挺大，上面只是分析了大致的流程，至于具体到其中的每一个函数调用，可能还涉及到很多不同的执行路径，不同的标志值，肯定要比上面的复杂的多，到时候还得根据实际情况，进一步的细读。</p>
</div>

  <footer>
    <p class="meta">

      

      
      <time datetime="2022-05-11 08:31:47 +0800" pubdate></time>
      

      
      <span class="categories">
	
      </span>
      

    </p>

    
    <div class="sharing">

      
      <a href="http://twitter.com/share"
	 class="twitter-share-button"
	 data-url="http://liubin.org/blog/2022/05/11/nydus-image-create/"
	 data-via="liubuneng"
	 data-counturl="http://liubin.org/blog/2022/05/11/nydus-image-create/" >Tweet</a>
      

      

      
      <div class="fb-like"
	   data-send="true"
	   data-width="450"
	   data-show-faces="false"></div>
      
    </div>
    

    

  </footer>
  
</div>

	<!-- /content -->
      </div>

      <footer role="contentinfo">
	<!-- include footer -->
	<p>
  Copyright &copy; 2022 - bin liu -
  <span>
    <a title="About" href="/about">About me</a>
  </span>
  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> 
</p>

	<!-- /include -->
      </footer>
      
      <!-- include after_footer -->
      



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




      <!-- /include -->

    </div>
  </body>
</html>
