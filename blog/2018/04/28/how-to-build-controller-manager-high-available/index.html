
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- include head -->
    

<meta charset="utf-8">
<title>向 Kubernetes 学习 - Controller manager 的高可用实现方式 - 自言自语</title>
<meta name="author" content="bin liu">
<meta name="description"
      content="向 Kubernetes 学习 - Controller manager 的高可用实现方式 这不是一系列入门级别的文章，也不是按部就班而来的，而是我看到哪里，发现有些代码写的精妙的地方，都值得我们学习下，顺手记录下来，一方面是让自己将来可以有迹可循，另外对大家应该也会有所帮助。 &hellip;">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="canonical" href="http://liubin.org/blog/2018/04/28/how-to-build-controller-manager-high-available">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css">
<link href="/atom.xml"
      rel="alternate"
      title="自言自语"
      type="application/atom+xml">




<script src="/javascripts/modernizr-2.0.js" type="text/javascript"></script>
<script src="/javascripts/ender.js" type="text/javascript"></script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5658682']);
  _gaq.push(['_trackPageview']);  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
      '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3ff1a0a2cfe6655d0058381167b966a9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <!-- /include -->
  </head>
  <body>
    <div id="wrapper">

      <header role="banner" class="site_metas">
	<!-- include header -->
	
<hgroup>
  <h1><a href="/">自言自语</a></h1>
  
  <h2>一个软件工程师的自言自语</h2>
  
</hgroup>

	<!-- /include -->
        <!-- include social_service_links -->
	
<div id="social-links">
  <ul>
    
    <li id="social-links-github">
      <a title="GitHub" href="https://github.com/liubin">github</a>
    </li>
    
    
    <li id="social-links-twitter">
      <a title="twitter" href="http://twitter.com/OurColorfulDays">twitter</a>
    </li>
    
    
    <li id="social-links-feed">
      <a title="feed" href="http://liubin.org/atom.xml">feed</a>
    </li>
  </ul>
</div>


        <!-- /include -->
      </header>

      <div id="content">
	<!-- content -->
	

  


<article class="entry" role="article">

  <header>
    <h2 class="entry_title">向 Kubernetes 学习 - Controller manager 的高可用实现方式</h2>
    
  </header>

  <div class="entry_content"><p>这不是一系列入门级别的文章，也不是按部就班而来的，而是我看到哪里，发现有些代码写的精妙的地方，都值得我们学习下，顺手记录下来，一方面是让自己将来可以有迹可循，另外对大家应该也会有所帮助。而且记录本身成本并不是很高。</p>

<p>高可用部署情况下，需要部署多个controller manager （以下简称 cm ），每个 cm 需要 <code>--leader-elect=true</code> 启动参数，即告知 cm 以高可用方式启动，谁要想进行真正的工作，必须先抢到锁，被选举为 leader 才行，而抢不到所得只能待机，在 leader 因为异常终止的时候，由剩余的其余节点再次获得锁。</p>

<p>关于分布式锁的实现很多，可以自己从零开始制造。当然更简单的是基于现有中间件，比如有基于 Redis 或数据库的实现方式，最近 Zookeeper/ETCD 也提供了相关功能。但 K8s 的实现并没有使用这些方式，而是另辟蹊径使用了资源锁的概念，简单来说就是通过创建 K8s 的资源（当前的实现中实现了 ConfigMap 和 Endpoint 两种类型的资源）来维护锁的状态。</p>

<p>分布式锁一般实现原理就是大家先去抢锁，抢到的人成为 leader ，然后 leader 会定期更新锁的状态，声明自己的活动状态，不让其他人把锁抢走。K8s 的资源锁也类似，抢到锁的节点会将自己的标记（目前是hostname）设为锁的持有者，其他人则需要通过对比锁的更新时间和持有者来判断自己是否能成为新的 leader ，而 leader 则可以通过更新 <code>RenewTime</code> 来确保持续保有该锁。</p>

<p>大概看了下 K8s 的实现，老实说其实现方式并不算高雅，但是却给我们开拓了一种思路：K8s 里的 resource 是万能的，不要以为 Endpoint 只是 Endpoint 。不过反过来有时候也挺让人费解的，刚了解的时候容易摸不着头脑，也不是好事。而且 scheduler 和 cm 都采用了资源锁，但是实现起来却不尽相同，也值得吐槽下。不管怎么说，这个实现算是挺有意思的实现，值得我们深入了解下。</p>

<p>我们首先来看一下 cm 启动的时候，是如何去 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/cmd/kube-controller-manager/app/controllermanager.go#L184-L208">初始化</a> 抢锁的。启动的时候，如果指定了 <code>--leader-elect=true</code> 参数的话，则会进入下面的代码，首先获取自己的资源标志（这里是 hostname 加一串随机数字）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Hostname</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// add a uniquifier so that two processes on the same host don&#39;t accidentally both become active</span>
</span><span class='line'><span class="nx">id</span> <span class="p">=</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">string</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nx">NewUUID</span><span class="p">())</span>
</span><span class='line'><span class="nx">rl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resourcelock</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">GenericComponent</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">ResourceLock</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;kube-system&quot;</span><span class="p">,</span>                                 <span class="c1">// 该资源所在 Namespace</span>
</span><span class='line'>  <span class="s">&quot;kube-controller-manager&quot;</span><span class="p">,</span>                     <span class="c1">// 资源名称</span>
</span><span class='line'>  <span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">LeaderElectionClient</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">(),</span>
</span><span class='line'>  <span class="nx">resourcelock</span><span class="p">.</span><span class="nx">ResourceLockConfig</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Identity</span><span class="p">:</span>      <span class="nx">id</span><span class="p">,</span>                         <span class="c1">// 锁持有者标志</span>
</span><span class='line'>      <span class="nx">EventRecorder</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">,</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面创建资源锁的代码说明请参考文中中文注释。</p>

<p>之后，在下面的代码中，资源锁，即上面的 rl（resource lock） 变量，被用于进行 leader 选举。具体的说明也嵌入在了下面的代码中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">leaderelection</span><span class="p">.</span><span class="nx">RunOrDie</span><span class="p">(</span><span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderElectionConfig</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">Lock</span><span class="p">:</span>          <span class="nx">rl</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// 下面 3 个参数是一些重时间，租赁期间等的设置，不是很重要</span>
</span><span class='line'>  <span class="nx">LeaseDuration</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">GenericComponent</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">LeaseDuration</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">RenewDeadline</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">GenericComponent</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">RenewDeadline</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">RetryPeriod</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">GenericComponent</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">RetryPeriod</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">Callbacks</span><span class="p">:</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderCallbacks</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">OnStartedLeading</span><span class="p">:</span> <span class="nx">run</span><span class="p">,</span>                   <span class="c1">// cm 的主要工作函数</span>
</span><span class='line'>      <span class="nx">OnStoppedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">glog</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;leaderelection lost&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们再来看看 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L85-L103">LeaderElectionConfig</a> 的内容，说明见注释（其实就是将代码的英文翻译过来而已）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">type</span> <span class="nx">LeaderElectionConfig</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 资源锁的实现对象</span>
</span><span class='line'>  <span class="nx">Lock</span> <span class="nx">rl</span><span class="p">.</span><span class="nx">Interface</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 是非 leader 在获取锁之前需要检查 leader 过期的时间</span>
</span><span class='line'>  <span class="nx">LeaseDuration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 当前 leader 尝试更新锁状态的期限。</span>
</span><span class='line'>  <span class="nx">RenewDeadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 抢锁时尝试间隔</span>
</span><span class='line'>  <span class="nx">RetryPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 锁状态发生变化的时候，需要进行处理的一组回调函数</span>
</span><span class='line'>  <span class="nx">Callbacks</span> <span class="nx">LeaderCallbacks</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L110-L119">Callbacks</a> 具体如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">Callbacks</span><span class="p">:</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderCallbacks</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">OnStartedLeading</span><span class="p">:</span> <span class="nx">run</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">OnStoppedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">glog</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;leaderelection lost&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，在获取锁（成为leader，<code>OnStartedLeading</code>）之后，将会执行 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/cmd/kube-controller-manager/app/controllermanager.go#L137"><code>run</code></a> 方法，在失去锁（<code>OnStoppedLeading</code>）之后打印错误消息后退出。<code>run</code> 方法是 cm 的主要方法，和抢锁选主流程没什么关系，这里就不介绍了。</p>

<p>下面的 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/interface.go#L37-L43">LeaderElectionRecord</a> 结构，保存了锁的信息，包括持有者（的hostname），获取时间，更新时间，leader 切换次数等（<code>LeaseDurationSeconds</code> 虽然定义了，但是并没有使用的感觉）。</p>

<p>这个结构可以说是资源锁中最重要的信息了，大家一定先混个脸熟，多念几遍 struct 的名字。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// LeaderElectionRecord is the record that is stored in the leader election annotation.</span>
</span><span class='line'><span class="c1">// This information should be used for observational purposes only and could be replaced</span>
</span><span class='line'><span class="c1">// with a random string (e.g. UUID) with only slight modification of this code.</span>
</span><span class='line'><span class="kd">type</span> <span class="nx">LeaderElectionRecord</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">HolderIdentity</span>       <span class="kt">string</span>      <span class="s">`json:&quot;holderIdentity&quot;`</span>
</span><span class='line'>  <span class="nx">LeaseDurationSeconds</span> <span class="kt">int</span>         <span class="s">`json:&quot;leaseDurationSeconds&quot;`</span>
</span><span class='line'>  <span class="nx">AcquireTime</span>          <span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&quot;acquireTime&quot;`</span>
</span><span class='line'>  <span class="nx">RenewTime</span>            <span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&quot;renewTime&quot;`</span>
</span><span class='line'>  <span class="nx">LeaderTransitions</span>    <span class="kt">int</span>         <span class="s">`json:&quot;leaderTransitions&quot;`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个锁信息，就是存在 K8s 的 ConfigMap 或者 Endpoint 里面的，当然，存哪里可能大家已经想到了，只能存 annotation 里面，该 annotation 的 key 就是 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/interface.go#L28"><code>control-plane.alpha.kubernetes.io/leader</code></a> 。</p>

<p>到这里总结一下就是：LeaderElectionRecord 用于保存锁的信息，但是这一信息会以 annotation 的方式，保存到 k8s 的 ConfigMap 或者 Endpoint 等资源里面。</p>

<p>下面我们来看一下资源锁的实现。</p>

<p><a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/interface.go#L57-L76">资源锁接口</a> 的定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Get</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">LeaderElectionRecord</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">Create</span><span class="p">(</span><span class="nx">ler</span> <span class="nx">LeaderElectionRecord</span><span class="p">)</span> <span class="kt">error</span>
</span><span class='line'>  <span class="nx">Update</span><span class="p">(</span><span class="nx">ler</span> <span class="nx">LeaderElectionRecord</span><span class="p">)</span> <span class="kt">error</span>
</span><span class='line'>  <span class="nx">RecordEvent</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">Identity</span><span class="p">()</span> <span class="kt">string</span>
</span><span class='line'>  <span class="nx">Describe</span><span class="p">()</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>基本实现了 CRUD 几个方法，当然这里没有 D ，即 Delete，因为也没必要 Delete， 下一次抢锁的时候，抢到的 Leader 直接 Update 就可以了。</p>

<p>关键的方法我们看前 3 个就够了： Get 用于获取锁的最新信息，Update 用于更新，Create 用于创建资源锁对象，估计对大多数集群来说，只有第一次的时候才会调用 Create 创建这个对象。RecordEvent 也可以关注下，这个 event 属于锁资源，里面会记录 leader 切换等事件。</p>

<p>这里我们以 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/endpointslock.go#L39">Endpoint</a> 为例（这也是默认的资源锁类型，该参数可以通过 <code>leader-elect-resource-lock</code> 来设置），来看看资源锁的具体实现。</p>

<p>下面的代码省略了对 error 的检查，你懂得。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// Get returns the election record from a Endpoints Annotation</span>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">el</span> <span class="o">*</span><span class="nx">EndpointsLock</span><span class="p">)</span> <span class="nx">Get</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">LeaderElectionRecord</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">record</span> <span class="nx">LeaderElectionRecord</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span><span class='line'>  <span class="c1">// el.e 就是一个正经的 Endpoint 资源对象。</span>
</span><span class='line'>  <span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nx">Get</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 去获取 control-plane.alpha.kubernetes.io/leader annotation。</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">recordBytes</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">LeaderElectionRecordAnnotationKey</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">recordBytes</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">record</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/endpointslock.go#L58">Create</a> 也很简单，就是一个普通的 Endpoint 对象，加上锁专用的 annotation ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nx">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Name</span><span class="p">:</span>      <span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Annotations</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>          <span class="nx">LeaderElectionRecordAnnotationKey</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">recordBytes</span><span class="p">),</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/resourcelock/endpointslock.go#L76">更新方法</a> 的主体如下，将 <code>LeaderElectionRecord</code> 结构的对象序列化为字符串后，存到 annotation：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">LeaderElectionRecordAnnotationKey</span><span class="p">]</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">recordBytes</span><span class="p">)</span>
</span><span class='line'><span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">EndpointsMeta</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nx">Update</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">e</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过上面的方法，我们应该已经了解到了，锁的实现主要载体是 LeaderElectionRecord 对象，其实我们完全可以自己实现其他类型的资源锁了，比如基于 Secret ，不过好像也没啥意义。</p>

<p>介绍了上面的实现基础，我们最后来看看抢锁及使用锁的过程，<a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L138-L148">主要的入口</a> 如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// Run starts the leader election loop</span>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nx">Run</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 先去抢锁，阻塞操作</span>
</span><span class='line'>  <span class="nx">le</span><span class="p">.</span><span class="nx">acquire</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span><span class='line'>  <span class="c1">// 抢到锁后，执行主函数，就是我们前面提到的 run 函数，通过 Callbacks.OnStartedLeading 回调启动</span>
</span><span class='line'>  <span class="k">go</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">.</span><span class="nx">OnStartedLeading</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// 抢到锁后，需要定期更新，确保自己一直持有该锁</span>
</span><span class='line'>  <span class="nx">le</span><span class="p">.</span><span class="nx">renew</span><span class="p">()</span>
</span><span class='line'>  <span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，里面主要调用了两个方法： <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L172-L187"><code>acquire</code></a> 和 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L190-L206"><code>renew</code></a> 。</p>

<p>我们先来看看 <code>acquire</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nx">acquire</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span><span class='line'>  <span class="nx">wait</span><span class="p">.</span><span class="nx">JitterUntil</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">succeeded</span> <span class="o">:=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">tryAcquireOrRenew</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">maybeReportTransition</span><span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">!</span><span class="nx">succeeded</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">glog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;failed to acquire lease %v&quot;</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">RecordEvent</span><span class="p">(</span><span class="s">&quot;became leader&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">glog</span><span class="p">.</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;successfully acquired lease %v&quot;</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">RetryPeriod</span><span class="p">,</span> <span class="nx">JitterFactor</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">stop</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现也很短，这个函数会通过 <code>wait.JitterUntil</code> 来定期调用 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.10/staging/src/k8s.io/client-go/tools/leaderelection/leaderelection.go#L211-L264"><code>tryAcquireOrRenew</code> 方法</a> 来获取锁，直到成功为止，如果获取不到锁，则会以 <code>RetryPeriod</code> 为间隔不断尝试。如果获取到锁，就会关闭 stop 通道（ <code>close(stop)</code> ），通知 <code>wait.JitterUntil</code> 停止尝试。<code>tryAcquireOrRenew</code> 是最核心的方法，我们会在介绍完 <code>renew</code> 方法之后再进行介绍。</p>

<p><code>renew</code> 只有在获取锁之后才会调用，它会通过持续更新资源锁的数据，来确保继续持有已获得的锁，保持自己的 leader 状态。这里还是用到了很多 <code>wait</code> 包里的方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nx">renew</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span><span class='line'>  <span class="nx">wait</span><span class="p">.</span><span class="nx">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">Poll</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">RetryPeriod</span><span class="p">,</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">RenewDeadline</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">le</span><span class="p">.</span><span class="nx">tryAcquireOrRenew</span><span class="p">(),</span> <span class="kc">nil</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">maybeReportTransition</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">desc</span> <span class="o">:=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Describe</span><span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">glog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;successfully renewed lease %v&quot;</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">RecordEvent</span><span class="p">(</span><span class="s">&quot;stopped leading&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">glog</span><span class="p">.</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;failed to renew lease %v: %v&quot;</span><span class="p">,</span> <span class="nx">desc</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">stop</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的精妙之处在于，<code>wait.Until</code> 会不断的调用 <code>wait.Poll</code> 方法，前者是进行无限循环操作，直到 <code>stop</code> chan 被关闭，<code>wait.Poll</code>则不断的对某一条件进行检查，以 <code>RetryPeriod</code> 为间隔，直到该条件返回true、error或者超时（上面的 RenewDeadline 参数）。这一条件是一个需要满足 <code>func() (bool, error)</code> 签名的方法，比如这个例子很简单，只是调用了 <code>le.tryAcquireOrRenew()</code>。</p>

<p><code>tryAcquireOrRenew</code> 方法本身不是一个阻塞操作，只返回 true/false，对应为获取到锁和没有获取到锁的状态。结合 <code>wait.Poll</code> 来使用，该函数返回会有以下几种情况：</p>

<ul>
<li><code>tryAcquireOrRenew</code> 获取到锁，返回 true</li>
<li><code>tryAcquireOrRenew</code> 没有获取到锁，返回 false</li>
<li><code>tryAcquireOrRenew</code> 超时，返回 <code>ErrWaitTimeout</code>（errors.New(&ldquo;timed out waiting for the condition&rdquo;)）</li>
</ul>


<p>最后，我们再来重点了解下 <code>tryAcquireOrRenew</code> 的内容。renew有两个功能，获取锁，或者在已经获取锁的时候，对锁进行更新，确保锁不被他人抢走。</p>

<p>具体的说明也放到了注释里，这段代码流程上不不复杂，但是需要对前后两个状态，以及 leader 和非 leader 两个角色的不同执行流程有所分辨。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nx">tryAcquireOrRenew</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">now</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>  <span class="c1">// 这个 leaderElectionRecord 就是保存在 Endpoint 的 annotation 中的值。</span>
</span><span class='line'>  <span class="c1">// 每个节点都将 HolderIdentity 设置为自己，以及关于获取和更新锁的时间。后面会对时间进行修正，才会更新到 API server</span>
</span><span class='line'>  <span class="nx">leaderElectionRecord</span> <span class="o">:=</span> <span class="nx">rl</span><span class="p">.</span><span class="nx">LeaderElectionRecord</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">HolderIdentity</span><span class="p">:</span>       <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Identity</span><span class="p">(),</span>
</span><span class='line'>      <span class="nx">LeaseDurationSeconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">LeaseDuration</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">RenewTime</span><span class="p">:</span>            <span class="nx">now</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">AcquireTime</span><span class="p">:</span>          <span class="nx">now</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 1. 获取或者创建 ElectionRecord</span>
</span><span class='line'>  <span class="nx">oldLeaderElectionRecord</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Get</span><span class="p">()</span>
</span><span class='line'>  <span class="c1">// 获取记录出错，有可能是记录不存在，这种错误需要处理。</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">glog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error retrieving resource lock %v: %v&quot;</span><span class="p">,</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Describe</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// 记录不存在的话，则创建一条新的记录</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">leaderElectionRecord</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">glog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error initially creating leader election record: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// 创建记录成功，同时表示获得了锁，返回true</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="nx">leaderElectionRecord</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 2. 正常获取了锁资源的记录，检查锁持有者和更新时间。</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">!</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">DeepEqual</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span><span class="p">,</span> <span class="o">*</span><span class="nx">oldLeaderElectionRecord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 记录之前的锁持有者，其实有可能就是自己。</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="o">*</span><span class="nx">oldLeaderElectionRecord</span>
</span><span class='line'>      <span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// 在满足以下所有的条件下，认为锁由他人持有，并且还没有过期，返回 false</span>
</span><span class='line'>  <span class="c1">// a. 当前锁持有者的并非自己</span>
</span><span class='line'>  <span class="c1">// b. 上一次观察时间 + 观测检查间隔大于现在时间，即距离上次观测的间隔，小于 `LeaseDuration` 的设置值。</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">LeaseDuration</span><span class="p">).</span><span class="nx">After</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span> <span class="o">!=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Identity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">glog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;lock is held by %v and has not yet expired&quot;</span><span class="p">,</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// 3. 更新资源的 annotation 内容。</span>
</span><span class='line'>  <span class="c1">// 在本函数开头 leaderElectionRecord 有一些字段被设置成了默认值，这里来设置正确的值。</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span> <span class="o">==</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Identity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 如果自己持有锁，则继承之前的获取时间和 leader 切换次数</span>
</span><span class='line'>      <span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">AcquireTime</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">AcquireTime</span>
</span><span class='line'>      <span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 发生 leader 切换，所以 LeaderTransitions + 1</span>
</span><span class='line'>      <span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 更新锁资源对象</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">leaderElectionRecord</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">glog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Failed to update lock: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="nx">leaderElectionRecord</span>
</span><span class='line'>  <span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>再回到 <code>renew</code> 方法，在被 <code>Poll</code> 阻塞住之后，只要 <code>Poll</code> 返回了，就可以继续执行下面的代码。<code>le.maybeReportTransition()</code> 很关键，里面会判断是否出现了 leader 的切换，进而调用 <code>Callbacks</code> 的 <code>OnNewLeader</code> 方法，尽管 cm 初始化的时候并没有设置这个 Callback 方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nx">maybeReportTransition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">observedRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span> <span class="o">==</span> <span class="nx">l</span><span class="p">.</span><span class="nx">reportedLeader</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">l</span><span class="p">.</span><span class="nx">reportedLeader</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">observedRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">.</span><span class="nx">OnNewLeader</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">go</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">.</span><span class="nx">OnNewLeader</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">reportedLeader</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码看起来比较烧脑，本文读起来也比较摸不着头，可能最好的办法就是一遍遍的阅读源代码了。</p>
</div>

  <footer>
    <p class="meta">

      

      
      <time datetime="2018-04-28 19:04:56 +0800" pubdate></time>
      

      
      <span class="categories">
	
      </span>
      

    </p>

    
    <div class="sharing">

      
      <a href="http://twitter.com/share"
	 class="twitter-share-button"
	 data-url="http://liubin.org/blog/2018/04/28/how-to-build-controller-manager-high-available/"
	 data-via="OurColorfulDays"
	 data-counturl="http://liubin.org/blog/2018/04/28/how-to-build-controller-manager-high-available/" >Tweet</a>
      

      

      
      <div class="fb-like"
	   data-send="true"
	   data-width="450"
	   data-show-faces="false"></div>
      
    </div>
    

    

  </footer>
  
</div>

	<!-- /content -->
      </div>

      <footer role="contentinfo">
	<!-- include footer -->
	<p>
  Copyright &copy; 2020 - bin liu -
  <span>
    <a title="About" href="/about">About me</a>
  </span>
  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> 
</p>

	<!-- /include -->
      </footer>
      
      <!-- include after_footer -->
      



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




      <!-- /include -->

    </div>
  </body>
</html>
